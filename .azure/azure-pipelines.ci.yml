# Continuous Integration (CI)

trigger:
  batch: true
  branches:
    include:
    - main
    - release/*
pr:
- main
- release/*

name: 0.$(Date:yyyy).$(Date:MM).$(DayOfMonth).$(Rev:rr).0

stages:

- stage: build_debug
  displayName: Build (Debug)
  dependsOn: []
  jobs:
  - template: ./templates/build.yml
    parameters:
      arch: x64
      config: Debug

- stage: build_release
  displayName: Build (Release)
  dependsOn: []
  jobs:
  - template: ./templates/build.yml
    parameters:
      arch: x64
      config: Release

- stage: test_debug
  displayName: Functional Tests (Debug)
  dependsOn:
  - build_debug
  jobs:
  - template: ./templates/tests.yml
    parameters:
      pool: MsQuic
      arch: x64
      config: Debug
  - template: ./templates/tests.yml
    parameters:
      pool: XDP-CI-1ES-Functional
      image: MMS2016
      arch: x64
      config: Debug
      ignoreFailures: true
  - template: ./templates/tests.yml
    parameters:
      pool: XDP-CI-1ES-Functional
      image: MMS2019
      arch: x64
      config: Debug
      ignoreFailures: true
  # - template: ./templates/tests.yml
  #   parameters:
  #     image: windows-2022
  #     arch: x64
  #     config: Debug

- stage: test_release
  displayName: Functional Tests (Release)
  dependsOn:
  - build_release
  jobs:
  - template: ./templates/tests.yml
    parameters:
      pool: MsQuic
      arch: x64
      config: Release
  - template: ./templates/tests.yml
    parameters:
      pool: XDP-CI-1ES-Functional
      image: MMS2016
      arch: x64
      config: Release
      ignoreFailures: true
  - template: ./templates/tests.yml
    parameters:
      pool: XDP-CI-1ES-Functional
      image: MMS2019
      arch: x64
      config: Release
      ignoreFailures: true
  # - template: ./templates/tests.yml
  #   parameters:
  #     image: windows-2022
  #     arch: x64
  #     config: Release

- stage: stress_debug
  displayName: Stress (Debug)
  dependsOn:
  - build_debug
  jobs:
  - template: ./templates/spinxsk.yml
    parameters:
      pool: MsQuic
      arch: x64
      config: Debug
  - template: ./templates/spinxsk.yml
    parameters:
      pool: XDP-CI-1ES-Spinxsk
      image: MMS2016TLS
      ignoreFailures: true
      arch: x64
      config: Debug
  - template: ./templates/spinxsk.yml
    parameters:
      pool: XDP-CI-1ES-Spinxsk
      image: MMS2019TLS
      ignoreFailures: true
      arch: x64
      config: Debug
  - template: ./templates/spinxsk.yml
    parameters:
      pool: XDP-CI-1ES-Spinxsk
      image: MMS2022TLS
      ignoreFailures: true
      arch: x64
      config: Debug
  - template: ./templates/spinxsk.yml
    parameters:
      image: windows-2022
      arch: x64
      config: Debug

- stage: stress_release
  displayName: Stress (Release)
  dependsOn:
  - build_release
  jobs:
  - template: ./templates/spinxsk.yml
    parameters:
      pool: MsQuic
      arch: x64
      config: Release
  - template: ./templates/spinxsk.yml
    parameters:
      pool: XDP-CI-1ES-Spinxsk
      image: MMS2016TLS
      ignoreFailures: true
      arch: x64
      config: Release
  - template: ./templates/spinxsk.yml
    parameters:
      pool: XDP-CI-1ES-Spinxsk
      image: MMS2019TLS
      ignoreFailures: true
      arch: x64
      config: Release
  - template: ./templates/spinxsk.yml
    parameters:
      pool: XDP-CI-1ES-Spinxsk
      image: MMS2022TLS
      ignoreFailures: true
      arch: x64
      config: Release
  - template: ./templates/spinxsk.yml
    parameters:
      image: windows-2022
      arch: x64
      config: Release

- stage: devkit
  displayName: Dev Kit
  dependsOn: build_release
  jobs:
  - template: ./templates/devkit.yml
    parameters:
      pool: MsQuic
      arch: x64
      config: Release
